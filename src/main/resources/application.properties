# Connector Admin Service Configuration
quarkus.application.name=connector-admin
quarkus.application.version=1.0.0-SNAPSHOT

# Container Image Configuration
//TODO: replace with git
quarkus.container-image.registry=git.rokkon.com
quarkus.container-image.group=ai-pipestream
quarkus.container-image.name=connector-admin
quarkus.container-image.tag=latest
quarkus.container-image.additional-tags=${quarkus.application.version}

# ======================================================================================================================
# HTTP / gRPC Configuration
# ======================================================================================================================
# Connector service port (38107)
quarkus.http.host=0.0.0.0
quarkus.http.port=38107
quarkus.grpc.server.use-separate-server=false
quarkus.grpc.server.enable-health-service=true
quarkus.grpc.server.enable-reflection-service=true
quarkus.grpc.server.max-inbound-message-size=2147483647

# gRPC client configuration to connect to the repository-service
quarkus.grpc.clients.repository.address=static://localhost:38102 # Point to repo-service
quarkus.grpc.clients.repository.max-inbound-message-size=2147483647

# Dev configuration
%dev.quarkus.http.port=38107
%dev.quarkus.http.root-path=/connector

# Test configuration
%test.quarkus.http.test-port=0
%test.quarkus.grpc.server.use-separate-server=false

# ======================================================================================================================
# Apicurio Registry Configuration
# ======================================================================================================================
quarkus.index-dependency.apicurio-registry.group-id=io.apicurio
quarkus.index-dependency.apicurio-registry.artifact-id=apicurio-registry-protobuf-serde-kafka

# ======================================================================================================================
# Kafka Configuration
# ======================================================================================================================
kafka.bootstrap.servers=${KAFKA_BOOTSTRAP_SERVERS:localhost:9094}
%dev.kafka.bootstrap.servers=localhost:9094
%prod.kafka.bootstrap.servers=kafka:9092

# Kafka Dev Services - disabled when using Compose Dev Services

# Account events consumer channel
mp.messaging.incoming.account-events.connector=smallrye-kafka
mp.messaging.incoming.account-events.value.deserializer=io.apicurio.registry.serde.protobuf.ProtobufKafkaDeserializer
mp.messaging.incoming.account-events.key.deserializer=org.apache.kafka.common.serialization.StringDeserializer
mp.messaging.incoming.account-events.apicurio.registry.serde.find-latest=true
mp.messaging.incoming.account-events.apicurio.registry.deserializer.value.return-class=ai.pipestream.repository.account.AccountEvent
mp.messaging.incoming.account-events.bootstrap.servers=${kafka.bootstrap.servers}
mp.messaging.incoming.account-events.group.id=connector-admin
mp.messaging.incoming.account-events.auto.offset.reset=earliest
%dev.mp.messaging.incoming.account-events.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# Kafka connector configuration
%dev.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${kafka.bootstrap.servers}
%dev.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://localhost:8081/apis/registry/v3

# ======================================================================================================================
# Database Configuration
# ======================================================================================================================
quarkus.datasource.db-kind=mysql
quarkus.datasource.username=pipeline
quarkus.datasource.password=password

# Dev mode - use MySQL dev service (port 3306) - separate database for connector-admin
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:3306/pipeline_connector_dev

# Hibernate configuration - use current property names
# Dev: Use Flyway migrations to manage schema
%dev.quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.flyway.migrate-at-start=true
%dev.quarkus.flyway.baseline-on-migrate=true

# Test: Clean database and let Hibernate create schema
%test.quarkus.hibernate-orm.schema-management.strategy=drop-and-create
%test.quarkus.hibernate-orm.sql-load-script=import.sql
%test.quarkus.flyway.migrate-at-start=false
%test.quarkus.flyway.clean-at-start=true

# Prod: Use migrations
%prod.quarkus.hibernate-orm.schema-management.strategy=validate
%prod.quarkus.flyway.migrate-at-start=true
%prod.quarkus.flyway.baseline-on-migrate=true

quarkus.hibernate-orm.sql-load-script=no-file

# ======================================================================================================================
# Dev Services Configuration
# ======================================================================================================================
# Compose Dev Services - Enable shared infrastructure for dev mode
%dev.quarkus.compose.devservices.enabled=true
%dev.quarkus.compose.devservices.files=${user.home}/.pipeline/compose-devservices.yml
%dev.quarkus.compose.devservices.project-name=pipeline-shared-devservices
%dev.quarkus.compose.devservices.start-services=true
%dev.quarkus.compose.devservices.stop-services=false
%dev.quarkus.compose.devservices.reuse-project-for-tests=true

# Kafka Dev Services - enabled, will use compose services when available
%dev.quarkus.kafka.devservices.enabled=true

%dev.quarkus.devservices.timeout=120s

# Test profile - use compose devservices with container hostnames (works in DinD!)
%test.quarkus.devservices.enabled=true
%test.quarkus.compose.devservices.files=src/test/resources/compose-test-services.yml
%test.quarkus.compose.devservices.start-services=true
%test.quarkus.compose.devservices.project-name=pipeline-test-services
%test.quarkus.compose.devservices.stop-services=false
%test.quarkus.compose.devservices.reuse-project-for-tests=true
%test.quarkus.compose.devservices.stop-timeout=30s

# Disable individual devservices (compose provides everything)
%test.quarkus.datasource.devservices.enabled=false
%test.quarkus.kafka.devservices.enabled=false

# Test datasource and Kafka config
# Local: uses localhost with mapped ports
# DinD: override with container hostnames via environment variables
%test.quarkus.datasource.jdbc.url=jdbc:mysql://${TEST_MYSQL_HOST:localhost}:${TEST_MYSQL_PORT:3307}/pipeline_connector_test
%test.quarkus.datasource.username=pipeline
%test.quarkus.datasource.password=password
%test.kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.bootstrap.servers=${TEST_KAFKA_HOST:localhost}:${TEST_KAFKA_PORT:9095}
%test.mp.messaging.connector.smallrye-kafka.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3
%test.mp.messaging.incoming.account-events.apicurio.registry.url=http://${TEST_APICURIO_HOST:localhost}:${TEST_APICURIO_PORT:8082}/apis/registry/v3

# ======================================================================================================================
# Service Registration Configuration
# ======================================================================================================================
service.registration.enabled=true
service.registration.service-name=connector-admin
service.registration.description=Connector registry and administration service
service.registration.service-type=APPLICATION
service.registration.host=${CONNECTOR_SERVICE_HOST:host.docker.internal}
service.registration.port=${quarkus.http.port}
service.registration.capabilities=connector-management,api-key-management
service.registration.tags=connector,admin,core-service,traefik.enable=true,traefik.http.routers.connector-service.rule=PathPrefix(`/connector`),traefik.http.routers.connector-service.entrypoints=web,traefik.http.middlewares.connector-slash.redirectregex.regex=^/connector$$,traefik.http.middlewares.connector-slash.redirectregex.replacement=/connector/,traefik.http.routers.connector-service.middlewares=connector-slash
%test.service.registration.enabled=false

# ======================================================================================================================
# Quinoa Configuration (Vue.js UI)
# ======================================================================================================================

# Static file serving configuration
quarkus.http.static-resources.connector-ui=/connector:build/quinoa/build
